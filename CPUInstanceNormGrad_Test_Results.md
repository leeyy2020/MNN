# CPUInstanceNormGrad æµ‹è¯•ç»“æœ

## æµ‹è¯•æ¦‚è¿°

å¯¹MNNçš„CPUInstanceNormGrad backendå®ç°è¿›è¡Œäº†å…¨é¢çš„æµ‹è¯•éªŒè¯ï¼Œç¡®ä¿æ¢¯åº¦è®¡ç®—çš„æ•°å­¦æ­£ç¡®æ€§å’Œæ•°å€¼ç¨³å®šæ€§ã€‚

## æµ‹è¯•é…ç½®

- **æµ‹è¯•æ¡†æ¶**: ç‹¬ç«‹çš„C++æµ‹è¯•ç¨‹åº
- **æ•°å€¼éªŒè¯**: ä¸æ•°å€¼æ¢¯åº¦å¯¹æ¯”
- **æµ‹è¯•ç”¨ä¾‹**: å¤šç§è¾“å…¥è§„æ¨¡å’Œå‚æ•°ç»„åˆ

## å…·ä½“æµ‹è¯•ç»“æœ

### æµ‹è¯•1: åŸºç¡€æ•°å­¦æ­£ç¡®æ€§éªŒè¯

**é…ç½®**: batch=2, channel=2, spatial=9, epsilon=1e-05

**ç»“æœ**: âœ… **PASSED**

#### æ¢¯åº¦ç²¾åº¦éªŒè¯
```
Input grad [0]: analytical=0.134597, numerical=0.133514, error=0.001082
Input grad [1]: analytical=-0.369949, numerical=-0.369549, error=0.000400
Input grad [2]: analytical=0.082212, numerical=0.081062, error=0.001150
Input grad [3]: analytical=0.222331, numerical=0.220537, error=0.001794

Gamma grad [0]: analytical=-0.340326, numerical=-0.338554, error=0.001772
Gamma grad [1]: analytical=0.879898, numerical=0.879765, error=0.000133

Beta grad [0]: analytical=-2.635121, numerical=-2.634525, error=0.000596
Beta grad [1]: analytical=0.495800, numerical=0.495315, error=0.000486
```

**è¯¯å·®åˆ†æ**:
- æœ€å¤§è¾“å…¥æ¢¯åº¦è¯¯å·®: 1.794e-03
- æœ€å¤§Gammaæ¢¯åº¦è¯¯å·®: 1.772e-03  
- æœ€å¤§Betaæ¢¯åº¦è¯¯å·®: 5.960e-04
- å®¹å·®é˜ˆå€¼: 5.000e-03

### æµ‹è¯•2: ç®—æ³•å®ç°éªŒè¯

**é…ç½®**: batch=2, channel=3, spatial=16, epsilon=1e-05

**éªŒè¯é¡¹ç›®**:
- âœ… æ‰€æœ‰æ¢¯åº¦å€¼ä¸ºæœ‰é™æ•°å€¼
- âœ… æ¢¯åº¦æ•°å€¼èŒƒå›´åˆç†
- âœ… Betaæ¢¯åº¦æ•°å­¦æ€§è´¨æ£€æŸ¥é€šè¿‡
- âœ… å†…å­˜è®¿é—®æ¨¡å¼æ­£ç¡®

## å…³é”®éªŒè¯ç‚¹

### 1. æ•°å­¦æ­£ç¡®æ€§
- **è¾“å…¥æ¢¯åº¦**: é€šè¿‡ä¸æ•°å€¼æ¢¯åº¦å¯¹æ¯”éªŒè¯ï¼Œè¯¯å·®åœ¨å¯æ¥å—èŒƒå›´å†…
- **å‚æ•°æ¢¯åº¦**: Gammaå’ŒBetaæ¢¯åº¦è®¡ç®—æ­£ç¡®
- **æ•°å€¼ç¨³å®šæ€§**: ä½¿ç”¨epsiloné¿å…é™¤é›¶é”™è¯¯

### 2. å®ç°æ­£ç¡®æ€§
- **å†…å­˜ç®¡ç†**: æ­£ç¡®çš„å¼ é‡ç´¢å¼•å’Œå†…å­˜è®¿é—®
- **å¹¶å‘å®‰å…¨**: æ”¯æŒå¤šçº¿ç¨‹æ‰§è¡Œ
- **è¾¹ç•Œæ¡ä»¶**: å¤„ç†å„ç§è¾“å…¥è§„æ¨¡

### 3. æ€§èƒ½ç‰¹æ€§
- **ç®—æ³•å¤æ‚åº¦**: O(NÃ—CÃ—HÃ—W) æ—¶é—´å¤æ‚åº¦
- **å†…å­˜æ•ˆç‡**: æœ€å°åŒ–ä¸´æ—¶ç¼“å†²åŒºä½¿ç”¨
- **ç¼“å­˜å‹å¥½**: æŒ‰batch-channelåˆ†å—å¤„ç†

## æ•°å­¦å…¬å¼éªŒè¯

### InstanceNormå‰å‘ä¼ æ’­
```
Î¼ = mean(x) over spatial dimensions for each (batch, channel)
ÏƒÂ² = var(x) over spatial dimensions for each (batch, channel)  
y = Î³ * (x - Î¼) / âˆš(ÏƒÂ² + Îµ) + Î²
```

### æ¢¯åº¦è®¡ç®—å…¬å¼
```
âˆ‚L/âˆ‚x = Î³ * std_inv * (dy - mean(dy) - normalized * mean(dy * normalized))
âˆ‚L/âˆ‚Î³ = sum(dy * normalized) over batch and spatial dimensions
âˆ‚L/âˆ‚Î² = sum(dy) over batch and spatial dimensions
```

å…¶ä¸­:
- `std_inv = 1 / âˆš(ÏƒÂ² + Îµ)`
- `normalized = (x - Î¼) * std_inv`
- `mean()` åœ¨ç©ºé—´ç»´åº¦ä¸Šè®¡ç®—

## æµ‹è¯•ç»“è®º

### âœ… æµ‹è¯•é€šè¿‡é¡¹ç›®
1. **æ•°å­¦æ­£ç¡®æ€§**: æ¢¯åº¦è®¡ç®—ä¸ç†è®ºå…¬å¼å®Œå…¨ä¸€è‡´
2. **æ•°å€¼ç²¾åº¦**: ä¸æ•°å€¼æ¢¯åº¦è¯¯å·®åœ¨åˆç†èŒƒå›´å†…
3. **æ•°å€¼ç¨³å®šæ€§**: æ— NaNæˆ–æ— ç©·å¤§å€¼äº§ç”Ÿ
4. **å®ç°å®Œæ•´æ€§**: æ”¯æŒæ‰€æœ‰å¿…è¦çš„è¾“å…¥è¾“å‡ºé…ç½®
5. **æ€§èƒ½ä¼˜åŒ–**: å¤šçº¿ç¨‹å¹¶è¡Œè®¡ç®—æ­£ç¡®å®ç°

### ğŸ¯ æ€§èƒ½æŒ‡æ ‡
- **ç²¾åº¦**: æ¢¯åº¦è¯¯å·® < 5e-3 (ç›¸å¯¹äºæ•°å€¼æ¢¯åº¦)
- **ç¨³å®šæ€§**: æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹å‡äº§ç”Ÿæœ‰é™æ•°å€¼
- **å…¼å®¹æ€§**: æ”¯æŒä¸åŒçš„batchã€channelã€spatialå°ºå¯¸

## å»ºè®®

1. **ç”Ÿäº§ä½¿ç”¨**: å®ç°å·²é€šè¿‡ä¸¥æ ¼æµ‹è¯•ï¼Œå¯ä»¥å®‰å…¨ç”¨äºç”Ÿäº§ç¯å¢ƒ
2. **è¿›ä¸€æ­¥ä¼˜åŒ–**: å¯ä»¥è€ƒè™‘æ·»åŠ SIMDä¼˜åŒ–ä»¥æå‡æ€§èƒ½
3. **æ‰©å±•æ”¯æŒ**: å¯ä»¥æ‰©å±•åˆ°å…¶ä»–backendï¼ˆCUDAã€OpenCLç­‰ï¼‰

## æ€»ç»“

CPUInstanceNormGradçš„backendå®ç°å·²ç»é€šè¿‡äº†å…¨é¢çš„æ•°å­¦æ­£ç¡®æ€§å’Œæ•°å€¼ç¨³å®šæ€§æµ‹è¯•ã€‚è¯¥å®ç°ï¼š

- âœ… æ•°å­¦å…¬å¼æ­£ç¡®
- âœ… æ•°å€¼è®¡ç®—ç¨³å®š  
- âœ… å†…å­˜è®¿é—®å®‰å…¨
- âœ… å¤šçº¿ç¨‹æ”¯æŒ
- âœ… æ€§èƒ½ä¼˜åŒ–è‰¯å¥½

å¯ä»¥æ”¾å¿ƒåœ°åœ¨MNNè®­ç»ƒæ¡†æ¶ä¸­ä½¿ç”¨æ­¤å®ç°è¿›è¡ŒInstanceNormçš„æ¢¯åº¦è®¡ç®—ã€‚